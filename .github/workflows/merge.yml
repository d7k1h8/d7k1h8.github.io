
name: Auto-merge auto to master and deploy to Pages
on:
  push:
    branches:
      - auto
    paths:
      # - 'couldron/**' # follows subdirectories
      - 'couldron/*.tar'
  workflow_dispatch:

# Combined permissions for both auto-merge and Pages deployment
permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "auto-merge-and-deploy"
  cancel-in-progress: true

jobs:
  auto-merge-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Debug current branch
        run: |
          echo "Current branch from GitHub context: ${{ github.ref_name }}"
          echo "Full ref: ${{ github.ref }}"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          lfs: true   # Enable Git LFS checkout for deployment

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge and process files
        id: merge
        run: |
          # Copy tar and webp files from auto branch to master
          # git checkout auto # already on auto
          [ -d "couldron" ]
          # Copy files to temporary location
          mkdir -p /tmp/couldron_files
          find couldron -type f \( -name '*.tar' -o -name '*.webp' \) -exec cp '{}' /tmp/couldron_files/ \;
          if ! rmdir /tmp/couldron_files 2>/dev/null; then
            exit 1
          fi

          # Switch to master and copy files
          git checkout master
          changes_made=false
          cd ./docs/img2
          find . -type f ! -name "*$(date -d '+1 hour' +'%Y%m%d')*" -exec mv '{}' ../img1 \;
          cp /tmp/couldron_files/* . 2>/dev/null

          # Extract tar files and remove them
          find . -name '*.tar' -type f -printf 'extracting %f\n' -exec tar -xf '{}' \; -delete
          cd ../..
          ./indexer.pl

          # Commit master changes
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add files from auto and extract tar files"
            changes_made=true
          fi

          # Set output for next steps
          echo "changes_made=$changes_made" >> $GITHUB_OUTPUT

      - name: Clean work branch
        run: |
          # Clean work branch
          git checkout auto
          find . -type f \( -name "*.webp" -o -name "*.tar" \) -delete
          git add -A
          git commit -m "Clean up files" || true

      - name: Push changes
        run: |
          git push origin master
          git push origin auto

      # Switch back to master branch before deploying
      - name: Switch to master for deployment
        if: steps.merge.outputs.changes_made == 'true'
        run: git checkout master

      # Deploy to GitHub Pages only if changes were made to master
      - name: Setup Pages
        if: steps.merge.outputs.changes_made == 'true'
        uses: actions/configure-pages@v5

      - name: Upload artifact
        if: steps.merge.outputs.changes_made == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'  # Upload the docs directory only

      - name: Deploy to GitHub Pages
        if: steps.merge.outputs.changes_made == 'true'
        id: deployment
        uses: actions/deploy-pages@v4
